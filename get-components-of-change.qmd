---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

# Get County Components of Change

https://www2.census.gov/programs-surveys/popest/datasets/


```{r}
#| label: setup

source(here::here("setup.R"))
```


## Census Components of Change

https://www.census.gov/programs-surveys/popest.html
https://www.census.gov/programs-surveys/popest/data/data-sets.html
https://www.census.gov/programs-surveys/international-programs/events/training/select-topics-in-international-population-health/demographic-change.html

### Files to use

-   [co-est2010-alldata.csv -- county-year 2000-2010 components of change](https://www2.census.gov/programs-surveys/popest/datasets/2010/2010-eval-estimates/co-est2010-alldata.csv) -- note that the Census folder is called "2010-eval-estimates" so perhaps these were not officially released
-   [co-est2020-alldata.csv -- county-year 2010-2020 components of change](https://www2.census.gov/programs-surveys/popest/datasets/2010-2020/counties/totals/co-est2020-alldata.csv)
-   [co-est2024-alldata.csv -- county-year 2020-2024 components of change](https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv)

The rate variables must be per thousand I think.

## Get data, combine, and save (1st step, raw data)

```{r}
#| label: get-2000-to-2010

# co-est2010-alldata.csv
# url <- "https://www2.census.gov/programs-surveys/popest/datasets/2010/2010-eval-estimates/co-est2010-alldata.csv"
# fname <- fs::path_file(url)
# download.file(url, fs::path(DCOC, fname), mode = "wb")

fname <- "co-est2010-alldata.csv"
fpath <- fs::path(DCOC, fname)
df <- vroom(fpath, col_types = cols(.default = col_character()))
count(df, SUMLEV)
glimpse(df)
dflong <- df |>
  rename_with(tolower) |>
  select(-region, -division) |>
  rename(stfips = state, cntyfips = county, cntyname = ctyname) |>
  mutate(
    geotype = case_when(
      sumlev == "040" ~ "state",
      sumlev == "050" ~ "county",
      .default = "ERROR"
    ),
    shortname = str_remove(cntyname, " County")
  ) |>
  pivot_longer(
    -c(sumlev, geotype, stfips, stname, cntyfips, cntyname, shortname)
  )

dflong

# how do the numbers fit together
# to compute npopchg_2002, youâ€™d typically need:
# births2002, deaths2002, netmig2002, and residual2002
check <- dflong |>
  filter(
    stfips == "36",
    cntyfips == "001",
    name %in%
      c(
        "popestimate2001",
        "popestimate2002",
        "npopchg_2002",
        "births2002",
        "deaths2002",
        "naturalinc2002",
        "domesticmig2002",
        "internationalmig2002",
        "netmig2002",
        "residual2002"
      )
  ) |>
  select(shortname, name, value)

check

abc


```

```{r}
#| label: get-2010-to-2020

# co-est2020-alldata.csv
# url <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2020/counties/totals/co-est2020-alldata.csv"
# fname <- fs::path_file(url)
# download.file(url, fs::path(DCOC, fname), mode = "wb")

```

```{r}
#| label: get-2020-plus

# co-est2024-alldata.csv

# url <- "https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv"
# fname <- fs::path_file(url)
# download.file(url, fs::path(DCOC, fname), mode = "wb")

```


## Old

```{r}
#| label: 2010-2019-coc
#| eval: false

# https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2010-2019/cc-est2019-alldata.pdf

fname <- "co-est2019-alldata.csv"
fpath <- fs::path(dcenpop, fname)

# the rate variables must be per thousand I think

df <- vroom(fpath, col_types = cols(.default = col_character()))

tmp <- df |>
  rename_with(str_to_lower) |>
  filter(state == "36", county == "115")
tmp |>
  pivot_longer(cols = -c(sumlev:ctyname)) |>
  filter(str_detect(name, "2018"))

tmp |>
  pivot_longer(cols = -c(sumlev:ctyname)) |>
  filter(str_detect(name, "rdeath")) # rnatural rnetmig

vars <- c("rbirth", "rdeath", "rnetmig")
vars <- c("rbirth", "rdeath", "rinternationalmig", "rdomesticmig")
vars <- c(
  "rbirth",
  "rdeath",
  "rinternationalmig",
  "rdomesticmig",
  "rnaturalinc"
)


tmp |>
  pivot_longer(cols = -c(sumlev:ctyname)) |>
  mutate(
    year = str_sub(name, -4, -1) |> as.integer(),
    var = str_remove(name, as.character(year)),
    value = as.numeric(value),
    value = value / 1000,
    value = ifelse(var == "rdeath", -value, value)
  ) |>
  filter(var %in% vars) |>
  ggplot(aes(year, value, colour = var)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(breaks = 2010:2020) +
  scale_y_continuous(
    breaks = seq(-.01, .02, .002),
    labels = scales::label_percent()
  ) +
  ggtitle("Change in population by cause as % of starting (?) population")

```

### 2020-2024

https://www.census.gov/data/datasets/time-series/demo/popest/2020s-counties-total.html
https://www2.census.gov/programs-surveys/popest/tables/2020-2024/counties/totals/co-est2024-comp.xlsx
https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv

```{r}
#| label: 2020-2024-coc
#| eval: false

# url <- "https://www2.census.gov/programs-surveys/popest/tables/2020-2024/counties/totals/co-est2024-comp.xlsx"
url <- "https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv"
fname <- fs::path_file(url)
download.file(url, fs::path(dcenpop, fname), mode = "wb")

```
