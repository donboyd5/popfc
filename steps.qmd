---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

# Steps

## TODO

-   read the 2008 Cornell documentation it looks helpful

## Setup

```{r}
#| label: setup

source(here::here("setup.R"))
```

```{r}
#| label: constants

mage_order <- c(
  "<15",
  "15-17",
  "18-19",
  "20-24",
  "25-29",
  "30-34",
  "35-39",
  "40-44",
  "45+",
  "Unknown",
  "Total"
)

```

## Notes

-   Be sure to understand difference between resident population, civilian population, and other differences. What are we using here? What did Cornell use? What should we use?
-   We can get control totals for population and components of change for the latest year [here](https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv).



### Make start-year population by sex and single year of age (sya)

Use cenpop_sya_sex.rds (based on cc-est2023-agesex-36.csv) for 2023 by sex, sya to allocate pop 2024 to sex, sya.

Save as `cntypop_sex_sya_2024`.

```{r}
#| label: pop-sex-sya

poptot <- readRDS(fs::path(DDATA, "pop_control.rds"))
popsya <- readRDS(fs::path(DWORK, "cenpop_sya_sex.rds"))

# for recent years, get control total population and estimate by sya and sex
pop_prep <- poptot |>
  filter(
    # year == max(year),
    year >= min(popsya$year),
    rectype == "county",
    program == "postcensal",
    src == "census"
  ) |> # all 62 counties
  select(stfips, cntyfips = cofips, area, year, value)

popshares <- popsya |> filter(year == max(year))

pop_sex_sya <- popsya |>
  select(-c(value)) |>
  left_join(
    pop_prep |> rename(shortname = area, poptot = value),
    by = join_by(stfips, cntyfips, year)
  ) |>
  mutate(pop = poptot * share) |>
  select(-share)

check <- pop_sex_sya |>
  summarise(
    pop = sum(pop),
    poptot = first(poptot),
    .by = c(stfips, cntyfips, area, shortname, year)
  )
summary(check)

saveRDS(pop_sex_sya, fs::path(DWORK, "cntypop_sex_sya_recent.rds"))


```

## Births

### Cornell notes

Age specific fertility rates were derived from Births by age of Mother (numerator) and Vintage 2017 Bridged-Race Postcensal Population Estimates (denominator).

This dataset has counts of births occurring within the United States to U.S. residents and non-residents. Counts can be obtained by state, county, urbanization, child's sex and weight, mother's bridged race, mother's single race, mother's age, mother's education, gestation period, prenatal care, birth plurality, medical and tobacco use risk factors (mother). The data are derived from birth certificates issued in years 2007 - 2023.

### My notes

Get updated data from data.ny.gov.

### Vital Statistics Live Births by Mother's Age and Resident County: Beginning 2008

Data sources:

-   Vital_Statistics_Live_Births_by_Mother_s_Age_and_Resident_County__Beginning_2008_20250604.csv (data.ny.gov) has # births by county and mother's age groups, 2008-

[live births by mother's age and county](https://health.data.ny.gov/Health/Vital-Statistics-Live-Births-by-Mother-s-Age-and-R/i7yg-w5rg/about_data)

```{r}
#| label: data.ny.gov

# data_raw\data_ny_gov\Vital_Statistics_Live_Births_by_Mother_s_Age_and_Resident_County__Beginning_2008_20250616.csv
# fname <- "Vital_Statistics_Live_Births_by_Mother_s_Age_and_Resident_County__Beginning_2008_20250604.csv"
fname <- "Vital_Statistics_Live_Births_by_Mother_s_Age_and_Resident_County__Beginning_2008_20250616.csv"
fpath <- fs::path(DNYG, fname)

df1 <- vroom::vroom(fpath)
df2 <- df1 |>
  select(year = Year, county = County, mage = 4, births = 5)

count(df2, mage)
df2 |>
  mutate(
    mage = factor(mage, levels = mage_order),
    pct = births[mage == "Unknown"] / births[mage == "Total"],
    .by = c(year, county)
  ) |>
  filter(pct != 0, mage == "Unknown") |> # unknown is minimal
  arrange(desc(abs(pct)))


mage_order <- c(
  "<15",
  "15-17",
  "18-19",
  "20-24",
  "25-29",
  "30-34",
  "35-39",
  "40-44",
  "45+",
  "Unknown",
  "Total"
)

df3 <- df2 |>
  mutate(
    mage = factor(mage, levels = mage_order),
    .by = c(year, county)
  )
count(df3, mage)


df2 |>
  filter(county == "Washington", mage == "Total") |>
  ggplot(aes(year, births)) +
  geom_point() +
  geom_line()

df2 |>
  filter(county == "Washington", mage != "Total") |>
  mutate(ma1 = str_sub(mage, 1, 1)) |>
  filter(ma1 %in% c("2", "3")) |>
  ggplot(aes(year, births, colour = mage)) +
  geom_point() +
  geom_line() +
  ggtitle("Washington County")

saveRDS(df2, fs::path(DWORK, "births.rds"))

```

### Vital Statistics Live Births and Fertility Rates by Mother's Age and County: Beginning 2008

data.ny.gov

[live births and fertility rates by mother's age and county](https://health.data.ny.gov/Health/Vital-Statistics-Live-Births-and-Fertility-Rates-b/c2tx-jecb/about_data)

```{r}
#| label: fertility-rates

# fname <- "Vital_Statistics_Live_Births_and_Fertility_Rates_by_Mother_s_Age_and_County__Beginning_2008_20250604.csv"
fname <- "Vital_Statistics_Live_Births_and_Fertility_Rates_by_Mother_s_Age_and_County__Beginning_2008_20250616.csv"
fpath <- fs::path(DNYG, fname)

# url <- "https://health.data.ny.gov/api/odata/v4/c2tx-jecb"
# qry <- "https://health.data.ny.gov/resource/c2tx-jecb.csv?$query=SELECT%0A%20%20%60year%60%2C%0A%20%20%60table%60%2C%0A%20%20%60county%60%2C%0A%20%20%60measure%60%2C%0A%20%20%60measurement%60%2C%0A%20%20%60mother_s_age_range%60%2C%0A%20%20%60value%60%0AORDER%20BY%0A%20%20%60year%60%20DESC%20NULL%20FIRST%2C%0A%20%20%60measure%60%20ASC%20NULL%20LAST%2C%0A%20%20%60county%60%20ASC%20NULL%20LAST%2C%0A%20%20%60mother_s_age_range%60%20ASC%20NULL%20LAST"
# outfile <-
# download.file(qry)

# Sys.setenv("VROOM_CONNECTION_SIZE"="")
# Sys.setenv("VROOM_CONNECTION_SIZE" = 1e6)

# df1 <- read_csv(fpath)

df1 <- vroom::vroom(fpath)
# df1 <- readr::read_csv(fpath)

df2 <- df1 |>
  select(
    year = Year,
    county = County,
    measure = 4,
    units = 5,
    mage = 6,
    rate = 7
  )

count(df2, mage)
count(df2, measure, units)

mage_order <- c(
  "<15",
  "15-17",
  "18-19",
  "20-24",
  "25-29",
  "30-34",
  "35-39",
  "40-44",
  "45+",
  "Unknown",
  "Total"
)

df3 <- df2 |>
  mutate(
    measure = case_when(
      measure == "Birth Rate" ~ "brate",
      measure == "Fertility Rate" ~ "frate",
      .default = "ERROR"
    )
  ) |>
  mutate(
    mage = factor(mage, levels = mage_order),
    .by = c(year, county),
  )
count(df3, mage)
count(df3, measure, units)
count(df3, measure, mage)

cnty <- "Washington"
check <- df3 |>
  filter(county == cnty, year %in% 2021:2022)

cnty <- "Albany"
cnty <- "Saratoga"
cnty <- "Washington"
df3 |>
  filter(county == cnty, mage == "Total", measure == "brate") |>
  ggplot(aes(year, rate)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)

df3 |>
  filter(county == cnty, mage == "Total") |>
  ggplot(aes(year, rate, colour = measure)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)


cnty <- "Albany"
df3 |>
  filter(county == cnty, mage != "Total", measure == "frate") |>
  mutate(ma1 = str_sub(mage, 1, 1)) |>
  filter(ma1 %in% c("2", "3")) |>
  ggplot(aes(year, rate, colour = mage)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)


frates <- df3 |>
  filter(measure == "frate") |>
  select(year, county, mage, fratek = rate)
saveRDS(frates, fs::path(DWORK, "frates.rds"))

```

### Calculate births and compare to reported

```{r}
#| label: check-births

mage_order <- c(
  "<15",
  "15-17",
  "18-19",
  "20-24",
  "25-29",
  "30-34",
  "35-39",
  "40-44",
  "45+",
  "Unknown",
  "Total"
)

pop <- readRDS(fs::path(DWORK, "cntypop_sex_sya_recent.rds"))
births <- readRDS(fs::path(DWORK, "births.rds"))
frates <- readRDS(fs::path(DWORK, "frates.rds"))

summary(frates)
count(frates, mage)

glimpse(pop)
summary(pop)

pop2 <- pop |>
  filter(name == "popf") |>
  filter(year %in% 2008:2022) |>
  mutate(
    county = str_remove(area, " County"),
    mage = case_when(
      age < 15 ~ "<15",
      age %in% 15:17 ~ "15-17",
      age %in% 18:19 ~ "18-19",
      age %in% 20:24 ~ "20-24",
      age %in% 25:29 ~ "25-29",
      age %in% 30:34 ~ "30-34",
      age %in% 35:39 ~ "35-39",
      age %in% 40:44 ~ "40-44",
      age >= 45 ~ "45+",
      .default = "ERROR"
    )
  )
summary(pop2)

check <- count(pop2, mage, age)
pop2 |>
  summarise(minage = min(age), maxage = max(age), .by = mage)


pop3 <- pop2 |>
  left_join(frates, join_by(year, county, mage)) |>
  mutate(births = pop / 1000 * fratek)

summary(pop3)

check <- pop3 |>
  summarise(births = sum(births, na.rm = TRUE), .by = c(county, year))

```

## Deaths

### Cornell notes

Life tables were created using age specific mortality rates that were derived from Deaths by sex and age (numerator) and Vintage 2017 Bridged-Race Postcensal Population Estimates (denominator).

URL: https://wonder.cdc.gov/cmf-icd10.html https://wonder.cdc.gov/Bridged-Race-v2017.HTML
Mortality rates for the 85+ age are corresponding with a life expectancy of 7.4 for males and 8.6 for females. **We assumed this is the same throughout the state.**

URL: https://www.health.ny.gov/statistics/vital_statistics/2015/table03.htm

### My notes

**How do I use this information? Read more.**

The Cornell link to NYSDOH life tables has life tables **for the state as a whole**, for 5-year age groupings. It seems like these would vary greatly by county due to race, ethnicity, and other demographic differences. They probably need to be adjusted to be consistent with Census components of change estimates by county.

Vital Statistics Deaths by Resident County, Region, Place of Death: Beginning 2003
Vital Statistics Deaths by Resident County, Region, and Race/Ethnicity: Beginning 2003
[**Vital Statistics Deaths by Resident County, Region, and Age-Group: Beginning 2003**](https://health.data.ny.gov/Health/Vital-Statistics-Deaths-by-Resident-County-Region-/xit9-mprv/about_data) -- note that this does not have gender

See [CDC](https://www.cdc.gov/nchs/products/life_tables.htm) for life tables methodology.
[Social Security Life Tables for the U.S.](https://www.ssa.gov/oact/STATS/table4c6.html)

[NYSDOH](https://www.health.ny.gov/statistics/vital_statistics/2022/)
Table 35 Deaths by Age and Resident County, New York State 2022
Table 36 Death Rates by Age and Resident County, New York State 2022
Table 39 Death Rates for Selected Causes of Death, by Resident County, New York State 2022
Table 40 Age-Sex Adjusted Death Rates for Selected Causes of Death by Resident County, New York State 2022

https://nyhealthfoundation.org/resource/life-expectancy-by-census-tract-in-new-york-state/#life-expectancy-income

[CDC Small area life expectancy files](https://www.cdc.gov/nchs/nvss/usaleep/usaleep.html#life-expectancy)

Maybe just use NYSDOH Table 3 age-group x sex life table and then try to improve.
Maybe use https://www.cdc.gov/nchs/nvss/usaleep/usaleep.html small area stuff abridged period table https://ftp.cdc.gov/pub/Health_Statistics/NCHS/Datasets/NVSS/USALEEP/XLSX/NY_B.XLSX which has by age group but not sex for several census tracts in Washington County.


https://ftp.cdc.gov/pub/Health_Statistics/NCHS/Publications/NVSR/72-12/
White non-Hispanic males US Table 17
White non-Hispanic females US Table 18

**NY_B.XLSX may be best geography, perhaps with details by NVSR Tables 17 and 18.**

## Migration

TO COME.

### Cornell notes


### My notes

