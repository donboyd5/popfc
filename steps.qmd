---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

# Steps

## Setup

```{r}
#| label: setup

source(here::here("setup.R"))
```

## Notes

-   Be sure to understand difference between resident population, civilian population, and other differences. What are we using here? What did Cornell use? What should we use?
-   We can get control totals for population and components of change for the latest year [here](https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv).

## Start population

Population by year, county, single year of age, and sex.

### Cornell notes

> We start with the population in 2015 (Data source: Vintage 2017 Bridged-Race Postcensal Population Estimates, downloaded though CDC-Wonder).

### My notes

Current equivalent is to find it from here: https://wonder.cdc.gov/bridged-race-population.html. I retrieved both the 2017 and 2020 vintages.

Note that CDC will not create this after the 1990-2020 vintage so maybe get directly from Census.

We can get postcensal (through 2023) age by 5-year groupings, and sex, by year and county within a state [here](https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/asrh/).

**For single year of age by sex data** go to the [county details landing page](https://www.census.gov/data/tables/time-series/demo/popest/2020s-counties-detail.html), page down for the single year of age tables, and get the [NY file cc-est2023-syasex-36.csv](https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/asrh/cc-est2023-syasex-36.csv). This is only available for 2020 to 2023 (not yet 2024) so we'd have to use this to break out the 2024 data.

### Census single-year of age by sex data

TODO.

```{r}
#| label: census-sex-sya

# this is NOT sya but rather grouped age!! cc-est2023-agesex-36.csv
df <- vroom::vroom(
  fs::path(DCENPOP, "2020-plus", "cc-est2023-syasex-36.csv"),
  col_types = cols(.default = col_character())
)

df1 <- df |>
  rename_with(str_to_lower) |>
  select(
    stfips = state,
    cntyfips = county,
    iyear = year,
    area = ctyname,
    age,
    pop = tot_pop,
    popm = tot_male,
    popf = tot_female
  ) |>
  mutate(
    iyear = as.integer(iyear),
    age = as.integer(age),
    across(c(pop, popm, popf), as.numeric)
  ) |>
  filter(iyear > 1) |>
  mutate(year = 2018 + iyear)

summary(df1)

# check male + female = total
df1 |> filter(pop != (popm + popf))

df2 <- df1 |>
  select(stfips, cntyfips, area, year, age, popm, popf) |>
  pivot_longer(cols = c(popm, popf)) |>
  mutate(share = value / sum(value), .by = c(stfips, cntyfips, area, year))

# washington county check
df2 |>
  filter(year == 2023, cntyfips == "115") |>
  summarise(value = sum(value), share = sum(share))

saveRDS(df2, fs::path(DWORK, "cenpop_sya_sex.rds"))

```

### CDC single-year of age by sex data (what Cornell used)

```{r}
#| label: get-start
#| eval: false

# fname <- "1990-2017 year state county sex age estimates for NY Washington County.txt"
fname <- "1990-2020 year state county sex age estimates for NY Washington County.txt"
fpath <- fs::path(DCDC, fname)

# "Notes"	"Yearly July 1st Estimates"	"Yearly July 1st Estimates Code"	"State"	"State Code"	"County"	"County Code"	"Sex"	"Sex Code"	"Age"	"Age Code"	Population
# everything is quoted but for population

# use fread because of the complexity of the input data

dt <- data.table::fread(
  fpath,
  skip = 1, # skip junk row(s) at the start
  nrows = 1e9, # adjust as needed to avoid junk rows at the end
  colClasses = "character",
  quote = "\""
) # the warning message is generated by notes rows at end -- ok to ignore

df <- dt |>
  as_tibble() |>
  select(
    year = V3,
    stfips = V5,
    state = V4,
    cntyfips = V7,
    county = V6,
    sex = V9,
    agec = V11,
    pop = V12
  ) |>
  mutate(
    year = as.integer(year),
    pop = as.numeric(pop),
    age = str_remove(agec, coll("+")) |> as.integer()
  )
count(df, age, agec) |> ht()

df |>
  summarise(pop = sum(pop), .by = year) |>
  ggplot(aes(year, pop)) +
  geom_line() +
  geom_point()

# saveRDS(df, fs::path(DDATA, "pop_start.rds"))

```

### Make start-year population by sex and single year of age (sya)

```{r}
#| label: pop-sex-sya

poptot <- readRDS(fs::path(DDATA, "pop_control.rds"))
popsya <- readRDS(fs::path(DWORK, "cenpop_sya_sex.rds"))

# for latest year, get control total population and estimate by sya and sex
poply <- poptot |>
  filter(
    year == max(year),
    rectype == "county",
    program == "postcensal",
    src == "census"
  ) |> # all 62 counties
  select(stfips, cntyfips = cofips, area, year, value)

popshares <- popsya |> filter(year == max(year))

pop_sex_sya <- popshares |>
  select(-c(year, value)) |>
  left_join(
    poply |> rename(shortname = area, poptot = value),
    by = join_by(stfips, cntyfips)
  ) |>
  mutate(pop = poptot * share) |> 
  select(-share)

check <- pop_sex_sya |> 
  summarise(pop = sum(pop), poptot = first(poptot),
  .by=c(stfips, cntyfips, area, shortname, year))

saveRDS(pop_sex_sya, fs::path(DWORK, "cntypop_sex_sya_2024.rds"))


```


## Births

### Cornell notes

Age specific fertility rates were derived from Births by age of Mother (numerator) and Vintage 2017 Bridged-Race Postcensal Population Estimates (denominator).

This dataset has counts of births occurring within the United States to U.S. residents and non-residents. Counts can be obtained by state, county, urbanization, child's sex and weight, mother's bridged race, mother's single race, mother's age, mother's education, gestation period, prenatal care, birth plurality, medical and tobacco use risk factors (mother). The data are derived from birth certificates issued in years 2007 - 2023.

### My notes

Get updated data from data.ny.gov.

### Vital Statistics Live Births by Mother's Age and Resident County: Beginning 2008

data.ny.gov

[live births by mother's age and county](https://health.data.ny.gov/Health/Vital-Statistics-Live-Births-by-Mother-s-Age-and-R/i7yg-w5rg/about_data)

```{r}
#| label: data.ny.gov

fname <- "Vital_Statistics_Live_Births_by_Mother_s_Age_and_Resident_County__Beginning_2008_20250604.csv"
fpath <- fs::path(DNYG, fname)

df1 <- read_csv(fpath)
df2 <- df1 |>
  select(year = Year, county = County, mage = 4, births = 5)

count(df2, mage)

df2 |>
  mutate(
    pct = births[mage == "Unknown"] / births[mage == "Total"],
    .by = c(year, county)
  ) |>
  filter(pct != 0, mage == "Unknown") |> # unknown is minimal
  arrange(desc(abs(pct)))

df2 |>
  filter(county == "Washington", mage == "Total") |>
  ggplot(aes(year, births)) +
  geom_point() +
  geom_line()

df2 |>
  filter(county == "Washington", mage != "Total") |>
  mutate(ma1 = str_sub(mage, 1, 1)) |>
  filter(ma1 %in% c("2", "3")) |>
  ggplot(aes(year, births, colour = mage)) +
  geom_point() +
  geom_line() +
  ggtitle("Washington County")

```

### Vital Statistics Live Births and Fertility Rates by Mother's Age and County: Beginning 2008

data.ny.gov

[live births and fertility rates by mother's age and county](https://health.data.ny.gov/Health/Vital-Statistics-Live-Births-and-Fertility-Rates-b/c2tx-jecb/about_data)

```{r}
#| label: fertility-rates

fname <- "Vital_Statistics_Live_Births_and_Fertility_Rates_by_Mother_s_Age_and_County__Beginning_2008_20250604.csv"
fpath <- fs::path(DNYG, fname)

df1 <- read_csv(fpath)
df2 <- df1 |>
  select(
    year = Year,
    county = County,
    measure = 4,
    units = 5,
    mage = 6,
    rate = 7
  )

count(df2, mage)
count(df2, measure, units)

df3 <- df2 |>
  mutate(
    measure = case_when(
      measure == "Birth Rate" ~ "brate",
      measure == "Fertility Rate" ~ "frate",
      .default = "ERROR"
    )
  )

count(df3, measure, units)

cnty <- "Washington"
check <- df3 |>
  filter(county == cnty, year %in% 2021:2022)

cnty <- "Albany"
cnty <- "Saratoga"
cnty <- "Washington"
df3 |>
  filter(county == cnty, mage == "Total", measure == "brate") |>
  ggplot(aes(year, rate)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)

df3 |>
  filter(county == cnty, mage == "Total") |>
  ggplot(aes(year, rate, colour = measure)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)


cnty <- "Albany"
df2 |>
  filter(county == cnty, mage != "Total") |>
  mutate(ma1 = str_sub(mage, 1, 1)) |>
  filter(ma1 %in% c("2", "3")) |>
  ggplot(aes(year, births, colour = mage)) +
  geom_point() +
  geom_line() +
  ggtitle("Washington County")

```

## Deaths

### Cornell notes

Life tables were created using age specific mortality rates that were derived from Deaths by sex and age (numerator) and Vintage 2017 Bridged-Race Postcensal Population Estimates (denominator).

URL: https://wonder.cdc.gov/cmf-icd10.html https://wonder.cdc.gov/Bridged-Race-v2017.HTML
Mortality rates for the 85+ age are corresponding with a life expectancy of 7.4 for males and 8.6 for females. **We assumed this is the same throughout the state.**

URL: https://www.health.ny.gov/statistics/vital_statistics/2015/table03.htm

### My notes

**How do I use this information? Read more.**

The Cornell link to NYSDOH life tables has life tables **for the state as a whole**, for 5-year age groupings. It seems like these would vary greatly by county due to race, ethnicity, and other demographic differences. They probably need to be adjusted to be consistent with Census components of change estimates by county.

Vital Statistics Deaths by Resident County, Region, Place of Death: Beginning 2003
Vital Statistics Deaths by Resident County, Region, and Race/Ethnicity: Beginning 2003
[**Vital Statistics Deaths by Resident County, Region, and Age-Group: Beginning 2003**](https://health.data.ny.gov/Health/Vital-Statistics-Deaths-by-Resident-County-Region-/xit9-mprv/about_data) -- note that this does not have gender

See [CDC](https://www.cdc.gov/nchs/products/life_tables.htm) for life tables methodology.
[Social Security Life Tables for the U.S.](https://www.ssa.gov/oact/STATS/table4c6.html)

[NYSDOH](https://www.health.ny.gov/statistics/vital_statistics/2022/)
Table 35 Deaths by Age and Resident County, New York State 2022
Table 36 Death Rates by Age and Resident County, New York State 2022
Table 39 Death Rates for Selected Causes of Death, by Resident County, New York State 2022
Table 40 Age-Sex Adjusted Death Rates for Selected Causes of Death by Resident County, New York State 2022

https://nyhealthfoundation.org/resource/life-expectancy-by-census-tract-in-new-york-state/#life-expectancy-income

[CDC Small area life expectancy files](https://www.cdc.gov/nchs/nvss/usaleep/usaleep.html#life-expectancy)

Maybe just use NYSDOH Table 3 age-group x sex life table and then try to improve.
Maybe use https://www.cdc.gov/nchs/nvss/usaleep/usaleep.html small area stuff abridged period table https://ftp.cdc.gov/pub/Health_Statistics/NCHS/Datasets/NVSS/USALEEP/XLSX/NY_B.XLSX which has by age group but not sex for several census tracts in Washington County.


https://ftp.cdc.gov/pub/Health_Statistics/NCHS/Publications/NVSR/72-12/
White non-Hispanic males US Table 17
White non-Hispanic females US Table 18

**NY_B.XLSX may be best geography, perhaps with details by NVSR Tables 17 and 18.**

## Migration

TO COME.

### Cornell notes


### My notes

