---
editor_options: 
  chunk_output_type: console
editor:
  markdown:
    canonical: true  
---

# Steps

## Setup

```{r}
#| label: setup

source(here::here("setup.R"))
```

## Notes

-   Be sure to understand difference between resident population, civilian population, and other differences. What are we using here? What did Cornell use? What should we use?
-   We can get control totals for population and components of change for the latest year [here](https://www2.census.gov/programs-surveys/popest/datasets/2020-2024/counties/totals/co-est2024-alldata.csv).

## Start population

Population by year, county, single year of age, and sex.

Cornell used:

> We start with the population in 2015 (Data source: Vintage 2017 Bridged-Race Postcensal Population Estimates, downloaded though CDC-Wonder).

Current equivalent is to find it from here: https://wonder.cdc.gov/bridged-race-population.html. I retrieved both the 2017 and 2020 vintages.

Note that CDC will not create this after the 1990-2020 vintage so maybe get directly from Census.

We can get postcensal (through 2023) age by 5-year groupings, and sex, by year and county within a state [here](https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/asrh/).

**For single year of age by sex data** go to the [county details landing page](https://www.census.gov/data/tables/time-series/demo/popest/2020s-counties-detail.html), page down for the single year of age tables, and get the [NY file cc-est2023-syasex-36.csv](https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/asrh/cc-est2023-syasex-36.csv). This is only available for 2020 to 2023 (not yet 2024) so we'd have to use this to break out the 2024 data.

### Census single-year of age by sex data

TODO.

### CDC single-year of age by sex data (what Cornell used)

```{r}
#| label: get-start

fname <- "1990-2017 year state county sex age estimates for NY Washington County.txt"
fpath <- fs::path(DCDC, fname)

# "Notes"	"Yearly July 1st Estimates"	"Yearly July 1st Estimates Code"	"State"	"State Code"	"County"	"County Code"	"Sex"	"Sex Code"	"Age"	"Age Code"	Population
# everything is quoted but for population

# use fread because of the complexity of the input data

dt <- data.table::fread(
  fpath,
  skip = 1, # skip junk row(s) at the start
  nrows = 1e9, # adjust as needed to avoid junk rows at the end
  colClasses = "character",
  quote = "\""
)

df <- dt |>
  as_tibble() |>
  select(
    year = V3,
    stfips = V5,
    state = V4,
    cntyfips = V7,
    county = V6,
    sex = V9,
    agec = V11,
    pop = V12
  ) |>
  mutate(
    year = as.integer(year),
    pop = as.numeric(pop),
    age = str_remove(agec, coll("+")) |> as.integer()
  )
count(df, age, agec) |> ht()

df |>
  summarise(pop = sum(pop), .by = year) |>
  ggplot(aes(year, pop)) +
  geom_line() +
  geom_point()

saveRDS(df, fs::path(DDATA, "pop_start.rds"))

```

## Births

Age specific fertility rates were derived from Births by age of Mother (numerator) and Vintage 2017 Bridged-Race Postcensal Population Estimates (denominator).

This dataset has counts of births occurring within the United States to U.S. residents and non-residents. Counts can be obtained by state, county, urbanization, child's sex and weight, mother's bridged race, mother's single race, mother's age, mother's education, gestation period, prenatal care, birth plurality, medical and tobacco use risk factors (mother). The data are derived from birth certificates issued in years 2007 - 2023.

### Vital Statistics Live Births by Mother's Age and Resident County: Beginning 2008

data.ny.gov

[live births by mother's age and county](https://health.data.ny.gov/Health/Vital-Statistics-Live-Births-by-Mother-s-Age-and-R/i7yg-w5rg/about_data)

```{r}
#| label: data.ny.gov

fname <- "Vital_Statistics_Live_Births_by_Mother_s_Age_and_Resident_County__Beginning_2008_20250604.csv"
fpath <- fs::path(DNYG, fname)

df1 <- read_csv(fpath)
df2 <- df1 |>
  select(year = Year, county = County, mage = 4, births = 5)

count(df2, mage)

df2 |>
  mutate(
    pct = births[mage == "Unknown"] / births[mage == "Total"],
    .by = c(year, county)
  ) |>
  filter(pct != 0, mage == "Unknown") |> # unknown is minimal
  arrange(desc(abs(pct)))

df2 |>
  filter(county == "Washington", mage == "Total") |>
  ggplot(aes(year, births)) +
  geom_point() +
  geom_line()

df2 |>
  filter(county == "Washington", mage != "Total") |>
  mutate(ma1 = str_sub(mage, 1, 1)) |>
  filter(ma1 %in% c("2", "3")) |>
  ggplot(aes(year, births, colour = mage)) +
  geom_point() +
  geom_line() +
  ggtitle("Washington County")

```

### Vital Statistics Live Births and Fertility Rates by Mother's Age and County: Beginning 2008

data.ny.gov

[live births and fertility rates by mother's age and county](https://health.data.ny.gov/Health/Vital-Statistics-Live-Births-and-Fertility-Rates-b/c2tx-jecb/about_data)



```{r}

fname <- "Vital_Statistics_Live_Births_and_Fertility_Rates_by_Mother_s_Age_and_County__Beginning_2008_20250604.csv"
fpath <- fs::path(DNYG, fname)

df1 <- read_csv(fpath)
df2 <- df1 |>
  select(
    year = Year,
    county = County,
    measure = 4,
    units = 5,
    mage = 6,
    rate = 7
  )

count(df2, mage)
count(df2, measure, units)

df3 <- df2 |>
  mutate(
    measure = case_when(
      measure == "Birth Rate" ~ "brate",
      measure == "Fertility Rate" ~ "frate",
      .default = "ERROR"
    )
  )

count(df3, measure, units)

cnty <- "Washington"
check <- df3 |>
  filter(county == cnty, year %in% 2021:2022) 

cnty <- "Albany"
cnty <- "Saratoga"
cnty <- "Washington"
df3 |>
  filter(county == cnty, mage == "Total", measure == "brate") |>
  ggplot(aes(year, rate)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)

df3 |>
  filter(county == cnty, mage == "Total") |>
  ggplot(aes(year, rate, colour = measure)) +
  geom_point() +
  geom_line() +
  ggtitle(cnty)


cnty <- "Albany"
df2 |>
  filter(county == cnty, mage != "Total") |>
  mutate(ma1 = str_sub(mage, 1, 1)) |>
  filter(ma1 %in% c("2", "3")) |>
  ggplot(aes(year, births, colour = mage)) +
  geom_point() +
  geom_line() +
  ggtitle("Washington County")

```


## Deaths

### Cornell notes

Life tables were created using age specific mortality rates that were derived from Deaths by sex and age (numerator) and Vintage 2017 Bridged-Race Postcensal Population Estimates (denominator).

URL: https://wonder.cdc.gov/cmf-icd10.html https://wonder.cdc.gov/Bridged-Race-v2017.HTML
Mortality rates for the 85+ age are corresponding with a life expectancy of 7.4 for males and 8.6 for females. **We assumed this is the same throughout the state.**

URL: https://www.health.ny.gov/statistics/vital_statistics/2015/table03.htm

### My notes

The Cornell link to NYSDOH life tables has life tables **for the state as a whole**, for 5-year age groupings. It seems like these would vary greatly by county due to race, ethnicity, and other demographic differences. They probably need to be adjusted to be consistent with Census components of change estimates by county.

## Migration

TO COME.
